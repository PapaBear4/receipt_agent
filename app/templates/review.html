<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt Agent — Review</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: start; }
    img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 6px; }
    textarea { width: 100%; height: 300px; }
    .field { margin-bottom: 0.75rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
    input[type="text"], input[type="number"] { width: 100%; padding: 0.5rem; }
    .card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; }
    .errors { background: #fee; border: 1px solid #f99; color: #900; padding: 0.75rem; margin-bottom: 1rem; }
    .actions { margin-top: 1rem; }
    .img-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; align-items: start; }
    .img-grid figure { margin: 0; }
  .img-grid img { width: 100%; height: 390px; object-fit: contain; background: #fff; }
    .img-grid figcaption { margin-top: 0.25rem; font-size: 0.9rem; color: #444; }
    @media (min-width: 1200px) {
      .img-grid img { height: 450px; }
    }
    .toolbar { display: flex; gap: 0.5rem; align-items: center; margin: 0.5rem 0 1rem; }
    .badge { margin-left: auto; padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 0.85rem; text-decoration: none; }
    .badge.ok { background: #e7f7ee; color: #0a7a3f; border: 1px solid #bfe7cf; }
    .key-hint { color: #666; font-size: 0.85rem; }
  </style>
</head>
<body>
  <h1 style="display:flex; align-items:center; gap:0.75rem;">Review & Edit
    {% if used_model %}
      <a href="/health/llm" target="_blank" title="LLM health and available models" class="badge ok">LLM: {{ used_model }}</a>
    {% endif %}
  </h1>
  {% if errors %}
  <div class="errors">
    <ul>
    {% for e in errors %}<li>{{ e }}</li>{% endfor %}
    </ul>
  </div>
  {% endif %}
  <div class="grid">
    <div class="card">
  <div class="toolbar">
    <div>
      <button type="button" id="zoomOut" title="[">−</button>
      <button type="button" id="zoomIn" title="]">+</button>
      {% if annotated_url %}
      <label style="margin-left:0.5rem;"><input type="checkbox" id="toggleOverlay" checked /> Show overlay</label>
      {% endif %}
    </div>
    <div class="key-hint">Hotkeys: [ and ] to zoom, o to toggle overlay, Ctrl/⌘+Enter to save</div>
  </div>
  <div class="img-grid">
    <figure>
      <img id="imgOriginal" src="{{ image_url }}" alt="Uploaded receipt" />
      <figcaption>Original</figcaption>
    </figure>
    {% if annotated_url %}
    <figure>
      <img id="imgAnnotated" src="{{ annotated_url }}" alt="Annotated overlay" />
      <figcaption>Annotated <span style="margin-left:0.5rem; font-weight:normal;">
        <span style="color:#ff6600">date</span>, <span style="color:#00aa00">payee</span>, <span style="color:#cc0000">total</span>
      </span></figcaption>
    </figure>
    {% endif %}
  </div>
  {% if ocr_json_url %}
  <p><a href="{{ ocr_json_url }}" download>Download OCR JSON</a></p>
  {% endif %}
  <p><a href="/metrics/llm" target="_blank" class="badge">LLM Metrics</a></p>
  {% if metrics %}
  <div class="card" style="margin:1rem 0;">
    <h3 style="margin-top:0;">LLM Metrics</h3>
    <div style="display:flex; flex-wrap:wrap; gap:1rem;">
      <div>
        <div><strong>Prompt</strong></div>
        <div>Chars: {{ metrics.prompt.chars }}</div>
        <div>Lines: {{ metrics.prompt.lines }}</div>
        <div>Indexed lines: {{ metrics.prompt.indexed_lines }}</div>
        <div>Full text included: {{ 'yes' if metrics.prompt.include_full_text else 'no' }}</div>
        <div>Limits: chars={{ metrics.prompt.max_chars }}, lines={{ metrics.prompt.max_lines }}</div>
  {% if metrics.prompt.cleanup %}
  <div style="margin-top:0.5rem;"><strong>OCR cleanup</strong></div>
  <div>Raw: {{ metrics.prompt.cleanup.raw_chars }} chars / {{ metrics.prompt.cleanup.raw_lines }} lines</div>
  <div>Cleaned: {{ metrics.prompt.cleanup.cleaned_chars }} chars / {{ metrics.prompt.cleanup.cleaned_lines }} lines</div>
  <div>Provided lines: {{ metrics.prompt.cleanup.provided_lines }} → After filter: {{ metrics.prompt.cleanup.provided_lines_cleaned }}</div>
  {% endif %}
      </div>
      <div>
        <div><strong>Response</strong></div>
        <div>Chars: {{ metrics.response.chars }}</div>
        <div>Prompt tokens: {{ metrics.response.prompt_tokens if metrics.response.prompt_tokens is not none else 'n/a' }}</div>
        <div>Completion tokens: {{ metrics.response.completion_tokens if metrics.response.completion_tokens is not none else 'n/a' }}</div>
        <div>Items parsed: {{ metrics.response.items }}</div>
      </div>
      <div>
        <div><strong>Timing</strong></div>
  <div>Wall: {{ '%.3f'|format(metrics.timing.get('wall_sec')) if metrics.timing and metrics.timing.get('wall_sec') is not none else 'n/a' }}s</div>
  <div>Total: {{ '%.3f'|format(metrics.timing.get('total_sec')) if metrics.timing and metrics.timing.get('total_sec') is not none else 'n/a' }}s</div>
  <div>Prompt eval: {{ '%.3f'|format(metrics.timing.get('prompt_eval_sec')) if metrics.timing and metrics.timing.get('prompt_eval_sec') is not none else 'n/a' }}s</div>
  <div>Completion eval: {{ '%.3f'|format(metrics.timing.get('eval_sec')) if metrics.timing and metrics.timing.get('eval_sec') is not none else 'n/a' }}s</div>
  <div>TPS (completion): {{ '%.1f'|format(metrics.timing.get('tps_completion')) if metrics.timing and metrics.timing.get('tps_completion') is not none else 'n/a' }}</div>
  <div>TPS (end-to-end): {{ '%.1f'|format(metrics.timing.get('tps_end_to_end')) if metrics.timing and metrics.timing.get('tps_end_to_end') is not none else 'n/a' }}</div>
      </div>
    </div>
  </div>
  {% endif %}
  <p>
    <a href="/review?file={{ stored_filename }}&rerun=1" title="Queue background job to re-run OCR and LLM (ignores cache)">Re-process (background)</a>
  </p>
  {% if assoc %}
      <ul>
        <li>Date → {{ assoc.date if assoc.date else 'n/a' }}</li>
        <li>Payee → {{ assoc.payee if assoc.payee else 'n/a' }}</li>
        <li>Total → {{ assoc.total if assoc.total else 'n/a' }}</li>
      </ul>
      {% endif %}
    </div>
    <div class="card">
      <form action="/save" method="post" id="reviewForm">
        <input type="hidden" name="stored_filename" value="{{ stored_filename }}" />
        <input type="hidden" name="original_filename" value="{{ original_filename }}" />
        <div class="field">
          <label for="date">Date (MM/DD/YYYY)</label>
          <input id="date" name="date" type="text" value="{{ date }}" required />
          {% if meta_sources and meta_sources.date %}
            <div class="key-hint">src: line {{ meta_sources.date.line_index }} · conf {{ '%.2f'|format(meta_sources.date.confidence) }}</div>
          {% endif %}
        </div>
        <div class="field">
          <label for="payee">Payee</label>
          <input id="payee" name="payee" type="text" value="{{ payee }}" required />
          {% if meta_sources and meta_sources.payee %}
            <div class="key-hint">src: line {{ meta_sources.payee.line_index }} · conf {{ '%.2f'|format(meta_sources.payee.confidence) }}</div>
          {% endif %}
        </div>
        <div class="field">
          <label for="outflow">Outflow</label>
          <input id="outflow" name="outflow" type="text" value="{{ outflow }}" required />
          {% if meta_sources and meta_sources.total %}
            <div class="key-hint">src: line {{ meta_sources.total.line_index }} · conf {{ '%.2f'|format(meta_sources.total.confidence) }}</div>
          {% endif %}
        </div>
        <div class="field">
          <label for="memo">Memo</label>
          <input id="memo" name="memo" type="text" value="{{ memo }}" required />
        </div>
  <h3>YNAB</h3>
  <div class="field">
    <label for="ynab_account_id">Account ID
      {% if suggestions and suggestions.account_id %}
        <span style="font-weight:normal; color:#555;">(suggested: {{ suggestions.account_name or suggestions.account_id }})</span>
      {% endif %}
    </label>
    <input id="ynab_account_id" type="text" value="{{ (suggestions.account_id if suggestions and suggestions.account_id else (config.YNAB_DEFAULT_ACCOUNT_ID if config and config.YNAB_DEFAULT_ACCOUNT_ID else '')) }}" />
  </div>
  {% if payment and payment.last4 %}
  <div class="field">
    <button type="button" id="saveAcctDefaultBtn" title="Remember this account for card {{ payment.last4 }}">Save as default for card ••••{{ payment.last4 }}</button>
    <span id="saveAcctDefaultStatus" class="muted" style="margin-left:0.5rem;"></span>
  </div>
  {% endif %}
  <div class="field"><label for="ynab_category_id">Category ID</label><input id="ynab_category_id" type="text" /></div>
        <h3>Payment Details</h3>
        <div class="field"><label>Subtotal</label><input name="subtotal" type="text" value="{{ payment.subtotal if payment else '' }}" /></div>
        <div class="field"><label>Tax</label><input name="tax" type="text" value="{{ payment.tax if payment else '' }}" /></div>
        <div class="field"><label>Tip</label><input name="tip" type="text" value="{{ payment.tip if payment else '' }}" /></div>
        <div class="field"><label>Discounts</label><input name="discounts" type="text" value="{{ payment.discounts if payment else '' }}" /></div>
        <div class="field"><label>Fees</label><input name="fees" type="text" value="{{ payment.fees if payment else '' }}" /></div>
        <div class="field"><label>Method</label><input name="method" type="text" value="{{ payment.method if payment else '' }}" /></div>
        <div class="field"><label>Last 4</label><input name="last4" type="text" value="{{ payment.last4 if payment else '' }}" />
          {% if meta_sources and meta_sources.payment and meta_sources.payment.last4 %}
            <div class="key-hint">src: line {{ meta_sources.payment.last4.line_index }} · conf {{ '%.2f'|format(meta_sources.payment.last4.confidence) }}</div>
          {% endif %}
        </div>

        <h3>Items</h3>
        <input type="hidden" name="items_json" id="items_json" />
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #ddd; text-align:left;">OCR Line</th>
              <th style="border-bottom:1px solid #ddd; text-align:left;">Best Guess (editable)</th>
              <th style="border-bottom:1px solid #ddd;">Qty</th>
              <th style="border-bottom:1px solid #ddd;">Unit</th>
              <th style="border-bottom:1px solid #ddd;">Amount</th>
              <th style="border-bottom:1px solid #ddd;">Conf</th>
              <th style="border-bottom:1px solid #ddd;">Src</th>
            </tr>
          </thead>
          <tbody id="items_tbody">
            {% for it in items %}
            <tr>
              <td style="padding:4px 6px; font-size:0.9rem; color:#555;">{{ it.ocr_text }}</td>
              <td style="padding:4px 6px;"><input type="text" class="it-name" value="{{ it.name }}" style="width:100%" data-line-index="{{ it.line_index }}" data-ocr-text="{{ it.ocr_text }}" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-qty" value="{{ '%.2f'|format(it.qty) if it.qty is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-unit" value="{{ '%.2f'|format(it.unit_price) if it.unit_price is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-amount" value="{{ '%.2f'|format(it.amount) if it.amount is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-conf" value="{{ '%.2f'|format(it.confidence) if it.confidence is defined else '' }}" min="0" max="1" step="0.01" /></td>
              <td style="padding:4px 6px; font-size:0.85rem; color:#666;">
                {% set src = (item_sources[loop.index0] if item_sources and loop.index0 < item_sources|length else None) %}
                {% if src %}
                  {% if src.name %}<div>name: line {{ src.name.line_index }} · {{ '%.2f'|format(src.name.confidence if src.name.confidence is defined else 0) }}</div>{% endif %}
                  {% if src.qty %}<div>qty: line {{ src.qty.line_index }} · {{ '%.2f'|format(src.qty.confidence if src.qty.confidence is defined else 0) }}</div>{% endif %}
                  {% if src.unit_price %}<div>unit: line {{ src.unit_price.line_index }} · {{ '%.2f'|format(src.unit_price.confidence if src.unit_price.confidence is defined else 0) }}</div>{% endif %}
                  {% if src.amount %}<div>amount: line {{ src.amount.line_index }} · {{ '%.2f'|format(src.amount.confidence if src.amount.confidence is defined else 0) }}</div>{% endif %}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="actions">
          <button type="submit">Save</button>
          <a href="/">Cancel</a>
          <button type="button" id="ynabBtn" style="margin-left:0.5rem;">Send to YNAB</button>
          <span id="ynabStatus" class="muted" style="margin-left:0.5rem;"></span>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function(){
      const imgOriginal = document.getElementById('imgOriginal');
      const imgAnnotated = document.getElementById('imgAnnotated');
      const zoomIn = document.getElementById('zoomIn');
      const zoomOut = document.getElementById('zoomOut');
      const toggleOverlay = document.getElementById('toggleOverlay');
      const form = document.getElementById('reviewForm');
  const itemsBody = document.getElementById('items_tbody');
  const itemsJson = document.getElementById('items_json');
  const storedInput = document.querySelector('input[name="stored_filename"]');
  
  const ynabBtn = document.getElementById('ynabBtn');
  const ynabStatus = document.getElementById('ynabStatus');
  const saveAcctDefaultBtn = document.getElementById('saveAcctDefaultBtn');
  const saveAcctDefaultStatus = document.getElementById('saveAcctDefaultStatus');
  

      let scale = 1.0;
      function applyScale() {
        const s = `scale(${scale})`;
        if (imgOriginal) { imgOriginal.style.transform = s; imgOriginal.style.transformOrigin = 'top left'; }
        if (imgAnnotated) { imgAnnotated.style.transform = s; imgAnnotated.style.transformOrigin = 'top left'; }
      }
      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      if (zoomIn) zoomIn.addEventListener('click', () => { scale = clamp(scale * 1.15, 0.5, 5); applyScale(); });
      if (zoomOut) zoomOut.addEventListener('click', () => { scale = clamp(scale / 1.15, 0.5, 5); applyScale(); });
      if (toggleOverlay && imgAnnotated) toggleOverlay.addEventListener('change', (e) => {
        imgAnnotated.style.display = e.target.checked ? '' : 'none';
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === '[') { scale = clamp(scale / 1.15, 0.5, 5); applyScale(); }
        else if (e.key === ']') { scale = clamp(scale * 1.15, 0.5, 5); applyScale(); }
        else if (e.key.toLowerCase() === 'o' && imgAnnotated && toggleOverlay) { toggleOverlay.checked = !toggleOverlay.checked; imgAnnotated.style.display = toggleOverlay.checked ? '' : 'none'; }
        else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { if (form) form.requestSubmit(); }
      });

      function collectItems() {
        const rows = itemsBody ? Array.from(itemsBody.querySelectorAll('tr')) : [];
        return rows.map(r => {
          const name = r.querySelector('.it-name');
          const qty = r.querySelector('.it-qty');
          const unit = r.querySelector('.it-unit');
          const amount = r.querySelector('.it-amount');
          const conf = r.querySelector('.it-conf');
          return {
            line_index: name ? parseInt(name.getAttribute('data-line-index')||'-1', 10) : -1,
            ocr_text: name ? (name.getAttribute('data-ocr-text')||'') : '',
            name: name ? name.value : '',
            qty: qty && qty.value ? parseFloat(qty.value) : 0,
            unit_price: unit && unit.value ? parseFloat(unit.value) : 0,
            amount: amount && amount.value ? parseFloat(amount.value) : 0,
            confidence: conf && conf.value ? Math.max(0, Math.min(1, parseFloat(conf.value))) : 0,
          };
        });
      }
      if (form && itemsJson) {
        form.addEventListener('submit', () => {
          try { itemsJson.value = JSON.stringify(collectItems()); } catch {}
        });
      }

      
      function applyResultToForm(obj){
        if (!obj) return;
        try {
          const d = document.getElementById('date'); if (d && obj.date) d.value = obj.date;
          const p = document.getElementById('payee'); if (p && obj.payee) p.value = obj.payee;
          const o = document.getElementById('outflow'); if (o && (obj.total!=null)) o.value = (parseFloat(obj.total)||0).toFixed(2);
          const pay = obj.payment || {};
          const set = (name, val)=>{ const el = document.querySelector(`[name="${name}"]`); if (el && (val!=null)) el.value = val; };
          set('subtotal', pay.subtotal); set('tax', pay.tax); set('tip', pay.tip); set('discounts', pay.discounts); set('fees', pay.fees); set('method', pay.method); set('last4', pay.last4);
          const items = obj.items || [];
          if (itemsBody) {
            itemsBody.innerHTML = '';
            items.forEach(it => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="padding:4px 6px; font-size:0.9rem; color:#555;">${(it.ocr_text||'')}</td>
                <td style="padding:4px 6px;"><input type="text" class="it-name" value="${(it.name||'')}" style="width:100%" data-line-index="${(it.line_index!=null?it.line_index:-1)}" data-ocr-text="${(it.ocr_text||'')}" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-qty" value="${(it.qty!=null?Number(it.qty).toFixed(2):'')}" step="0.01" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-unit" value="${(it.unit_price!=null?Number(it.unit_price).toFixed(2):'')}" step="0.01" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-amount" value="${(it.amount!=null?Number(it.amount).toFixed(2):'')}" step="0.01" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-conf" value="${(it.confidence!=null?Number(it.confidence).toFixed(2):'')}" min="0" max="1" step="0.01" /></td>`;
              itemsBody.appendChild(tr);
            });
          }
        } catch {}
      }
      

      // YNAB push
      if (ynabBtn) ynabBtn.addEventListener('click', async ()=>{
        try {
          ynabStatus.textContent = 'Sending…';
          const fd = new FormData();
          const stored = document.querySelector('input[name="stored_filename"]').value;
          fd.append('stored_filename', stored);
          fd.append('date', (document.getElementById('date')?.value||''));
          fd.append('payee', (document.getElementById('payee')?.value||''));
          fd.append('outflow', (document.getElementById('outflow')?.value||''));
          fd.append('memo', (document.getElementById('memo')?.value||''));
          // Optional account/category: basic inputs if present
          const acc = document.getElementById('ynab_account_id');
          const cat = document.getElementById('ynab_category_id');
          if (acc && acc.value) fd.append('account_id', acc.value);
          if (cat && cat.value) fd.append('category_id', cat.value);
          const r = await fetch('/ynab/push', { method: 'POST', body: fd });
          const j = await r.json();
          ynabStatus.textContent = j.ok ? 'Sent ✓' : ('Error: '+(j.error||'failed'));
        } catch(e){ ynabStatus.textContent = 'Error sending'; }
      });

  // streaming removed

      // Save durable mapping for account by last4
      if (saveAcctDefaultBtn) saveAcctDefaultBtn.addEventListener('click', async ()=>{
        try {
          const acct = document.getElementById('ynab_account_id');
          const last4El = document.querySelector('[name="last4"]');
          const last4 = last4El ? (last4El.value||'').trim() : '';
          const acctId = acct ? (acct.value||'').trim() : '';
          if (!last4 || !acctId) { saveAcctDefaultStatus.textContent = 'Missing last4 or account id'; return; }
          saveAcctDefaultStatus.textContent = 'Saving…';
          const fd = new FormData(); fd.append('key_last4', last4); fd.append('chosen_id', acctId);
          await fetch('/ynab/mapping/account', { method: 'POST', body: fd });
          saveAcctDefaultStatus.textContent = 'Saved ✓';
        } catch(e){ saveAcctDefaultStatus.textContent = 'Error saving'; }
      });
    })();
  </script>
</body>
</html>
