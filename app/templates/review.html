<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt Agent — Review</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: start; }
    img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 6px; }
    textarea { width: 100%; height: 300px; }
    .field { margin-bottom: 0.75rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
    input[type="text"], input[type="number"] { width: 100%; padding: 0.5rem; }
    .card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; }
    .errors { background: #fee; border: 1px solid #f99; color: #900; padding: 0.75rem; margin-bottom: 1rem; }
    .actions { margin-top: 1rem; }
    .img-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; align-items: start; }
    .img-grid figure { margin: 0; }
  .img-grid img { width: 100%; height: 390px; object-fit: contain; background: #fff; }
    .img-grid figcaption { margin-top: 0.25rem; font-size: 0.9rem; color: #444; }
    @media (min-width: 1200px) {
      .img-grid img { height: 450px; }
    }
    .toolbar { display: flex; gap: 0.5rem; align-items: center; margin: 0.5rem 0 1rem; }
    .badge { margin-left: auto; padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 0.85rem; text-decoration: none; }
    .badge.ok { background: #e7f7ee; color: #0a7a3f; border: 1px solid #bfe7cf; }
    .key-hint { color: #666; font-size: 0.85rem; }
  </style>
</head>
<body>
  <h1 style="display:flex; align-items:center; gap:0.75rem;">Review & Edit
    {% if used_model %}
      <a href="/health/llm" target="_blank" title="LLM health and available models" class="badge ok">LLM: {{ used_model }}</a>
    {% endif %}
  </h1>
  {% if errors %}
  <div class="errors">
    <ul>
    {% for e in errors %}<li>{{ e }}</li>{% endfor %}
    </ul>
  </div>
  {% endif %}
  <div class="grid">
    <div class="card">
  <div class="toolbar">
    <div>
      <button type="button" id="zoomOut" title="[">−</button>
      <button type="button" id="zoomIn" title="]">+</button>
      {% if annotated_url %}
      <label style="margin-left:0.5rem;"><input type="checkbox" id="toggleOverlay" checked /> Show overlay</label>
      {% endif %}
    </div>
    <div class="key-hint">Hotkeys: [ and ] to zoom, o to toggle overlay, Ctrl/⌘+Enter to save</div>
  </div>
  <div class="img-grid">
    <figure>
      <img id="imgOriginal" src="{{ image_url }}" alt="Uploaded receipt" />
      <figcaption>Original</figcaption>
    </figure>
    {% if annotated_url %}
    <figure>
      <img id="imgAnnotated" src="{{ annotated_url }}" alt="Annotated overlay" />
      <figcaption>Annotated <span style="margin-left:0.5rem; font-weight:normal;">
        <span style="color:#ff6600">date</span>, <span style="color:#00aa00">payee</span>, <span style="color:#cc0000">total</span>
      </span></figcaption>
    </figure>
    {% endif %}
  </div>
  {% if ocr_json_url %}
  <p><a href="{{ ocr_json_url }}" download>Download OCR JSON</a></p>
  {% endif %}
  <p>
    <a href="/review?file={{ stored_filename }}&rerun=1" title="Re-run OCR and LLM ignoring cache">Re-process</a>
  </p>
      <h3>Raw OCR Text</h3>
      <textarea readonly>{{ raw_text }}</textarea>
      {% if ocr_lines and assoc %}
      <h3>Matched Lines</h3>
      <ul>
        <li>Date → {{ assoc.date if assoc.date else 'n/a' }}</li>
        <li>Payee → {{ assoc.payee if assoc.payee else 'n/a' }}</li>
        <li>Total → {{ assoc.total if assoc.total else 'n/a' }}</li>
      </ul>
      {% endif %}
    </div>
    <div class="card">
      <form action="/save" method="post" id="reviewForm">
        <input type="hidden" name="stored_filename" value="{{ stored_filename }}" />
        <input type="hidden" name="original_filename" value="{{ original_filename }}" />
        <div class="field">
          <label for="date">Date (MM/DD/YYYY)</label>
          <input id="date" name="date" type="text" value="{{ date }}" required />
        </div>
        <div class="field">
          <label for="payee">Payee</label>
          <input id="payee" name="payee" type="text" value="{{ payee }}" required />
        </div>
        <div class="field">
          <label for="outflow">Outflow</label>
          <input id="outflow" name="outflow" type="text" value="{{ outflow }}" required />
        </div>
        <div class="field">
          <label for="memo">Memo</label>
          <input id="memo" name="memo" type="text" value="{{ memo }}" required />
        </div>
        <h3>Payment Details</h3>
        <div class="field"><label>Subtotal</label><input name="subtotal" type="text" value="{{ payment.subtotal if payment else '' }}" /></div>
        <div class="field"><label>Tax</label><input name="tax" type="text" value="{{ payment.tax if payment else '' }}" /></div>
        <div class="field"><label>Tip</label><input name="tip" type="text" value="{{ payment.tip if payment else '' }}" /></div>
        <div class="field"><label>Discounts</label><input name="discounts" type="text" value="{{ payment.discounts if payment else '' }}" /></div>
        <div class="field"><label>Fees</label><input name="fees" type="text" value="{{ payment.fees if payment else '' }}" /></div>
        <div class="field"><label>Method</label><input name="method" type="text" value="{{ payment.method if payment else '' }}" /></div>
        <div class="field"><label>Last 4</label><input name="last4" type="text" value="{{ payment.last4 if payment else '' }}" /></div>

        <h3>Items</h3>
        <input type="hidden" name="items_json" id="items_json" />
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #ddd; text-align:left;">OCR Line</th>
              <th style="border-bottom:1px solid #ddd; text-align:left;">Best Guess (editable)</th>
              <th style="border-bottom:1px solid #ddd;">Qty</th>
              <th style="border-bottom:1px solid #ddd;">Unit</th>
              <th style="border-bottom:1px solid #ddd;">Amount</th>
              <th style="border-bottom:1px solid #ddd;">Conf</th>
            </tr>
          </thead>
          <tbody id="items_tbody">
            {% for it in items %}
            <tr>
              <td style="padding:4px 6px; font-size:0.9rem; color:#555;">{{ it.ocr_text }}</td>
              <td style="padding:4px 6px;"><input type="text" class="it-name" value="{{ it.name }}" style="width:100%" data-line-index="{{ it.line_index }}" data-ocr-text="{{ it.ocr_text }}" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-qty" value="{{ '%.2f'|format(it.qty) if it.qty is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-unit" value="{{ '%.2f'|format(it.unit_price) if it.unit_price is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-amount" value="{{ '%.2f'|format(it.amount) if it.amount is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-conf" value="{{ '%.2f'|format(it.confidence) if it.confidence is defined else '' }}" min="0" max="1" step="0.01" /></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="actions">
          <button type="submit">Save</button>
          <a href="/">Cancel</a>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function(){
      const imgOriginal = document.getElementById('imgOriginal');
      const imgAnnotated = document.getElementById('imgAnnotated');
      const zoomIn = document.getElementById('zoomIn');
      const zoomOut = document.getElementById('zoomOut');
      const toggleOverlay = document.getElementById('toggleOverlay');
      const form = document.getElementById('reviewForm');
  const itemsBody = document.getElementById('items_tbody');
  const itemsJson = document.getElementById('items_json');

      let scale = 1.0;
      function applyScale() {
        const s = `scale(${scale})`;
        if (imgOriginal) { imgOriginal.style.transform = s; imgOriginal.style.transformOrigin = 'top left'; }
        if (imgAnnotated) { imgAnnotated.style.transform = s; imgAnnotated.style.transformOrigin = 'top left'; }
      }
      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      if (zoomIn) zoomIn.addEventListener('click', () => { scale = clamp(scale * 1.15, 0.5, 5); applyScale(); });
      if (zoomOut) zoomOut.addEventListener('click', () => { scale = clamp(scale / 1.15, 0.5, 5); applyScale(); });
      if (toggleOverlay && imgAnnotated) toggleOverlay.addEventListener('change', (e) => {
        imgAnnotated.style.display = e.target.checked ? '' : 'none';
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === '[') { scale = clamp(scale / 1.15, 0.5, 5); applyScale(); }
        else if (e.key === ']') { scale = clamp(scale * 1.15, 0.5, 5); applyScale(); }
        else if (e.key.toLowerCase() === 'o' && imgAnnotated && toggleOverlay) { toggleOverlay.checked = !toggleOverlay.checked; imgAnnotated.style.display = toggleOverlay.checked ? '' : 'none'; }
        else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { if (form) form.requestSubmit(); }
      });

      function collectItems() {
        const rows = itemsBody ? Array.from(itemsBody.querySelectorAll('tr')) : [];
        return rows.map(r => {
          const name = r.querySelector('.it-name');
          const qty = r.querySelector('.it-qty');
          const unit = r.querySelector('.it-unit');
          const amount = r.querySelector('.it-amount');
          const conf = r.querySelector('.it-conf');
          return {
            line_index: name ? parseInt(name.getAttribute('data-line-index')||'-1', 10) : -1,
            ocr_text: name ? (name.getAttribute('data-ocr-text')||'') : '',
            name: name ? name.value : '',
            qty: qty && qty.value ? parseFloat(qty.value) : 0,
            unit_price: unit && unit.value ? parseFloat(unit.value) : 0,
            amount: amount && amount.value ? parseFloat(amount.value) : 0,
            confidence: conf && conf.value ? Math.max(0, Math.min(1, parseFloat(conf.value))) : 0,
          };
        });
      }
      if (form && itemsJson) {
        form.addEventListener('submit', () => {
          try { itemsJson.value = JSON.stringify(collectItems()); } catch {}
        });
      }
    })();
  </script>
</body>
</html>
