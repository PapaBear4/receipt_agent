<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt Agent — Review</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: start; }
    img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 6px; }
    textarea { width: 100%; height: 300px; }
    .field { margin-bottom: 0.75rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
    input[type="text"], input[type="number"] { width: 100%; padding: 0.5rem; }
    .card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; }
    .errors { background: #fee; border: 1px solid #f99; color: #900; padding: 0.75rem; margin-bottom: 1rem; }
    .actions { margin-top: 1rem; }
    .img-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; align-items: start; }
    .img-grid figure { margin: 0; }
  .img-grid img { width: 100%; height: 390px; object-fit: contain; background: #fff; }
    .img-grid figcaption { margin-top: 0.25rem; font-size: 0.9rem; color: #444; }
    @media (min-width: 1200px) {
      .img-grid img { height: 450px; }
    }
    .toolbar { display: flex; gap: 0.5rem; align-items: center; margin: 0.5rem 0 1rem; }
    .badge { margin-left: auto; padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 0.85rem; text-decoration: none; }
    .badge.ok { background: #e7f7ee; color: #0a7a3f; border: 1px solid #bfe7cf; }
    .key-hint { color: #666; font-size: 0.85rem; }
  </style>
</head>
<body>
  <h1 style="display:flex; align-items:center; gap:0.75rem;">Review & Edit
    {% if used_model %}
      <a href="/health/llm" target="_blank" title="LLM health and available models" class="badge ok">LLM: {{ used_model }}</a>
    {% endif %}
  </h1>
  {% if errors %}
  <div class="errors">
    <ul>
    {% for e in errors %}<li>{{ e }}</li>{% endfor %}
    </ul>
  </div>
  {% endif %}
  <div class="grid">
    <div class="card">
  <div class="toolbar">
    <div>
      <button type="button" id="zoomOut" title="[">−</button>
      <button type="button" id="zoomIn" title="]">+</button>
      {% if annotated_url %}
      <label style="margin-left:0.5rem;"><input type="checkbox" id="toggleOverlay" checked /> Show overlay</label>
      {% endif %}
    </div>
    <div class="key-hint">Hotkeys: [ and ] to zoom, o to toggle overlay, Ctrl/⌘+Enter to save</div>
  </div>
  <div class="img-grid">
    <figure>
      <img id="imgOriginal" src="{{ image_url }}" alt="Uploaded receipt" />
      <figcaption>Original</figcaption>
    </figure>
    {% if annotated_url %}
    <figure>
      <img id="imgAnnotated" src="{{ annotated_url }}" alt="Annotated overlay" />
      <figcaption>Annotated <span style="margin-left:0.5rem; font-weight:normal;">
        <span style="color:#ff6600">date</span>, <span style="color:#00aa00">payee</span>, <span style="color:#cc0000">total</span>
      </span></figcaption>
    </figure>
    {% endif %}
  </div>
  {% if ocr_json_url %}
  <p><a href="{{ ocr_json_url }}" download>Download OCR JSON</a></p>
  {% endif %}
  <div class="card" style="margin:1rem 0;">
    <h3 style="margin-top:0; display:flex; align-items:center; gap:0.5rem;">Live LLM Stream
      <button type="button" id="streamBtn" style="margin-left:auto;">Start</button>
      <button type="button" id="streamStopBtn">Stop</button>
      <a href="/metrics/llm" target="_blank" class="badge" style="margin-left:0.5rem;">LLM Metrics</a>
    </h3>
    <div id="streamPanel" style="display:none;">
      <div id="streamStatus" class="muted" style="margin-bottom:0.5rem; color:#666;">Idle</div>
      <pre id="streamLog" style="background:#fafafa; border:1px solid #eee; padding:8px; height:160px; overflow:auto; white-space:pre-wrap;"></pre>
      <div id="streamSummary" style="margin-top:0.5rem;"></div>
      <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
        <button type="button" id="applyStreamBtn" disabled>Apply to form</button>
        <span id="streamStats" class="muted" style="align-self:center; color:#666;"></span>
        <span id="eta" class="muted" style="align-self:center; color:#666;"></span>
      </div>
    </div>
  </div>
  {% if metrics %}
  <div class="card" style="margin:1rem 0;">
    <h3 style="margin-top:0;">LLM Metrics</h3>
    <div style="display:flex; flex-wrap:wrap; gap:1rem;">
      <div>
        <div><strong>Prompt</strong></div>
        <div>Chars: {{ metrics.prompt.chars }}</div>
        <div>Lines: {{ metrics.prompt.lines }}</div>
        <div>Indexed lines: {{ metrics.prompt.indexed_lines }}</div>
        <div>Full text included: {{ 'yes' if metrics.prompt.include_full_text else 'no' }}</div>
        <div>Limits: chars={{ metrics.prompt.max_chars }}, lines={{ metrics.prompt.max_lines }}</div>
  {% if metrics.prompt.cleanup %}
  <div style="margin-top:0.5rem;"><strong>OCR cleanup</strong></div>
  <div>Raw: {{ metrics.prompt.cleanup.raw_chars }} chars / {{ metrics.prompt.cleanup.raw_lines }} lines</div>
  <div>Cleaned: {{ metrics.prompt.cleanup.cleaned_chars }} chars / {{ metrics.prompt.cleanup.cleaned_lines }} lines</div>
  <div>Provided lines: {{ metrics.prompt.cleanup.provided_lines }} → After filter: {{ metrics.prompt.cleanup.provided_lines_cleaned }}</div>
  {% endif %}
      </div>
      <div>
        <div><strong>Response</strong></div>
        <div>Chars: {{ metrics.response.chars }}</div>
        <div>Prompt tokens: {{ metrics.response.prompt_tokens if metrics.response.prompt_tokens is not none else 'n/a' }}</div>
        <div>Completion tokens: {{ metrics.response.completion_tokens if metrics.response.completion_tokens is not none else 'n/a' }}</div>
        <div>Items parsed: {{ metrics.response.items }}</div>
      </div>
      <div>
        <div><strong>Timing</strong></div>
        <div>Wall: {{ '%.3f'|format(metrics.timing.wall_sec) if metrics.timing.wall_sec is not none else 'n/a' }}s</div>
        <div>Total: {{ '%.3f'|format(metrics.timing.total_sec) if metrics.timing.total_sec is not none else 'n/a' }}s</div>
        <div>Prompt eval: {{ '%.3f'|format(metrics.timing.prompt_eval_sec) if metrics.timing.prompt_eval_sec is not none else 'n/a' }}s</div>
        <div>Completion eval: {{ '%.3f'|format(metrics.timing.eval_sec) if metrics.timing.eval_sec is not none else 'n/a' }}s</div>
        <div>TPS (completion): {{ '%.1f'|format(metrics.timing.tps_completion) if metrics.timing.tps_completion is not none else 'n/a' }}</div>
        <div>TPS (end-to-end): {{ '%.1f'|format(metrics.timing.tps_end_to_end) if metrics.timing.tps_end_to_end is not none else 'n/a' }}</div>
      </div>
    </div>
  </div>
  {% endif %}
  <p>
    <a href="/review?file={{ stored_filename }}&rerun=1" title="Re-run OCR and LLM ignoring cache">Re-process</a>
  &nbsp;|&nbsp;
  <a href="#" id="streamLink" title="Stream LLM output live">Live Re-process (stream)</a>
  </p>
      <h3>Raw OCR Text</h3>
      <textarea readonly>{{ raw_text }}</textarea>
      {% if ocr_lines and assoc %}
      <h3>Matched Lines</h3>
      <ul>
        <li>Date → {{ assoc.date if assoc.date else 'n/a' }}</li>
        <li>Payee → {{ assoc.payee if assoc.payee else 'n/a' }}</li>
        <li>Total → {{ assoc.total if assoc.total else 'n/a' }}</li>
      </ul>
      {% endif %}
    </div>
    <div class="card">
      <form action="/save" method="post" id="reviewForm">
        <input type="hidden" name="stored_filename" value="{{ stored_filename }}" />
        <input type="hidden" name="original_filename" value="{{ original_filename }}" />
        <div class="field">
          <label for="date">Date (MM/DD/YYYY)</label>
          <input id="date" name="date" type="text" value="{{ date }}" required />
        </div>
        <div class="field">
          <label for="payee">Payee</label>
          <input id="payee" name="payee" type="text" value="{{ payee }}" required />
        </div>
        <div class="field">
          <label for="outflow">Outflow</label>
          <input id="outflow" name="outflow" type="text" value="{{ outflow }}" required />
        </div>
        <div class="field">
          <label for="memo">Memo</label>
          <input id="memo" name="memo" type="text" value="{{ memo }}" required />
        </div>
        <h3>Payment Details</h3>
        <div class="field"><label>Subtotal</label><input name="subtotal" type="text" value="{{ payment.subtotal if payment else '' }}" /></div>
        <div class="field"><label>Tax</label><input name="tax" type="text" value="{{ payment.tax if payment else '' }}" /></div>
        <div class="field"><label>Tip</label><input name="tip" type="text" value="{{ payment.tip if payment else '' }}" /></div>
        <div class="field"><label>Discounts</label><input name="discounts" type="text" value="{{ payment.discounts if payment else '' }}" /></div>
        <div class="field"><label>Fees</label><input name="fees" type="text" value="{{ payment.fees if payment else '' }}" /></div>
        <div class="field"><label>Method</label><input name="method" type="text" value="{{ payment.method if payment else '' }}" /></div>
        <div class="field"><label>Last 4</label><input name="last4" type="text" value="{{ payment.last4 if payment else '' }}" /></div>

        <h3>Items</h3>
        <input type="hidden" name="items_json" id="items_json" />
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #ddd; text-align:left;">OCR Line</th>
              <th style="border-bottom:1px solid #ddd; text-align:left;">Best Guess (editable)</th>
              <th style="border-bottom:1px solid #ddd;">Qty</th>
              <th style="border-bottom:1px solid #ddd;">Unit</th>
              <th style="border-bottom:1px solid #ddd;">Amount</th>
              <th style="border-bottom:1px solid #ddd;">Conf</th>
            </tr>
          </thead>
          <tbody id="items_tbody">
            {% for it in items %}
            <tr>
              <td style="padding:4px 6px; font-size:0.9rem; color:#555;">{{ it.ocr_text }}</td>
              <td style="padding:4px 6px;"><input type="text" class="it-name" value="{{ it.name }}" style="width:100%" data-line-index="{{ it.line_index }}" data-ocr-text="{{ it.ocr_text }}" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-qty" value="{{ '%.2f'|format(it.qty) if it.qty is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-unit" value="{{ '%.2f'|format(it.unit_price) if it.unit_price is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-amount" value="{{ '%.2f'|format(it.amount) if it.amount is defined else '' }}" step="0.01" /></td>
              <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-conf" value="{{ '%.2f'|format(it.confidence) if it.confidence is defined else '' }}" min="0" max="1" step="0.01" /></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="actions">
          <button type="submit">Save</button>
          <a href="/">Cancel</a>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function(){
      const imgOriginal = document.getElementById('imgOriginal');
      const imgAnnotated = document.getElementById('imgAnnotated');
      const zoomIn = document.getElementById('zoomIn');
      const zoomOut = document.getElementById('zoomOut');
      const toggleOverlay = document.getElementById('toggleOverlay');
      const form = document.getElementById('reviewForm');
  const itemsBody = document.getElementById('items_tbody');
  const itemsJson = document.getElementById('items_json');
  const streamBtn = document.getElementById('streamBtn');
  const streamStopBtn = document.getElementById('streamStopBtn');
  const streamLink = document.getElementById('streamLink');
  const streamPanel = document.getElementById('streamPanel');
  const streamLog = document.getElementById('streamLog');
  const streamStatus = document.getElementById('streamStatus');
  const streamSummary = document.getElementById('streamSummary');
  const applyStreamBtn = document.getElementById('applyStreamBtn');
  const streamStats = document.getElementById('streamStats');
  const etaEl = document.getElementById('eta');
  const storedInput = document.querySelector('input[name="stored_filename"]');
  let es = null;
  let lastStreamObj = null;
  let lastStreamMetrics = null;
  let sid = null;
  let avgTpsCache = null;
  let avgWallCache = null;

      let scale = 1.0;
      function applyScale() {
        const s = `scale(${scale})`;
        if (imgOriginal) { imgOriginal.style.transform = s; imgOriginal.style.transformOrigin = 'top left'; }
        if (imgAnnotated) { imgAnnotated.style.transform = s; imgAnnotated.style.transformOrigin = 'top left'; }
      }
      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      if (zoomIn) zoomIn.addEventListener('click', () => { scale = clamp(scale * 1.15, 0.5, 5); applyScale(); });
      if (zoomOut) zoomOut.addEventListener('click', () => { scale = clamp(scale / 1.15, 0.5, 5); applyScale(); });
      if (toggleOverlay && imgAnnotated) toggleOverlay.addEventListener('change', (e) => {
        imgAnnotated.style.display = e.target.checked ? '' : 'none';
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === '[') { scale = clamp(scale / 1.15, 0.5, 5); applyScale(); }
        else if (e.key === ']') { scale = clamp(scale * 1.15, 0.5, 5); applyScale(); }
        else if (e.key.toLowerCase() === 'o' && imgAnnotated && toggleOverlay) { toggleOverlay.checked = !toggleOverlay.checked; imgAnnotated.style.display = toggleOverlay.checked ? '' : 'none'; }
        else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { if (form) form.requestSubmit(); }
      });

      function collectItems() {
        const rows = itemsBody ? Array.from(itemsBody.querySelectorAll('tr')) : [];
        return rows.map(r => {
          const name = r.querySelector('.it-name');
          const qty = r.querySelector('.it-qty');
          const unit = r.querySelector('.it-unit');
          const amount = r.querySelector('.it-amount');
          const conf = r.querySelector('.it-conf');
          return {
            line_index: name ? parseInt(name.getAttribute('data-line-index')||'-1', 10) : -1,
            ocr_text: name ? (name.getAttribute('data-ocr-text')||'') : '',
            name: name ? name.value : '',
            qty: qty && qty.value ? parseFloat(qty.value) : 0,
            unit_price: unit && unit.value ? parseFloat(unit.value) : 0,
            amount: amount && amount.value ? parseFloat(amount.value) : 0,
            confidence: conf && conf.value ? Math.max(0, Math.min(1, parseFloat(conf.value))) : 0,
          };
        });
      }
      if (form && itemsJson) {
        form.addEventListener('submit', () => {
          try { itemsJson.value = JSON.stringify(collectItems()); } catch {}
        });
      }

      function appendLog(text) {
        if (!streamLog) return;
        streamLog.textContent += text;
        streamLog.scrollTop = streamLog.scrollHeight;
      }
      function fmtSecs(s){ return s != null ? (Math.round(s*10)/10)+'s' : 'n/a'; }
      function renderMetrics(m){
        if (!m) return '';
        const p = m.prompt || {}; const t = m.timing || {}; const r = m.response || {};
        return `Prompt: ${p.chars||0} chars, ${p.lines||0} lines; indexed ${p.indexed_lines||0}; full text ${p.include_full_text?'yes':'no'}\n`
             + `Timing: wall ${fmtSecs(t.wall_sec)}; eval ${fmtSecs(t.eval_sec)}; TPS(e2e) ${t.tps_end_to_end? t.tps_end_to_end.toFixed(1):'n/a'}`;
      }
      function applyResultToForm(obj){
        if (!obj) return;
        try {
          const d = document.getElementById('date'); if (d && obj.date) d.value = obj.date;
          const p = document.getElementById('payee'); if (p && obj.payee) p.value = obj.payee;
          const o = document.getElementById('outflow'); if (o && (obj.total!=null)) o.value = (parseFloat(obj.total)||0).toFixed(2);
          const pay = obj.payment || {};
          const set = (name, val)=>{ const el = document.querySelector(`[name="${name}"]`); if (el && (val!=null)) el.value = val; };
          set('subtotal', pay.subtotal); set('tax', pay.tax); set('tip', pay.tip); set('discounts', pay.discounts); set('fees', pay.fees); set('method', pay.method); set('last4', pay.last4);
          const items = obj.items || [];
          if (itemsBody) {
            itemsBody.innerHTML = '';
            items.forEach(it => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="padding:4px 6px; font-size:0.9rem; color:#555;">${(it.ocr_text||'')}</td>
                <td style="padding:4px 6px;"><input type="text" class="it-name" value="${(it.name||'')}" style="width:100%" data-line-index="${(it.line_index!=null?it.line_index:-1)}" data-ocr-text="${(it.ocr_text||'')}" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-qty" value="${(it.qty!=null?Number(it.qty).toFixed(2):'')}" step="0.01" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-unit" value="${(it.unit_price!=null?Number(it.unit_price).toFixed(2):'')}" step="0.01" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-amount" value="${(it.amount!=null?Number(it.amount).toFixed(2):'')}" step="0.01" /></td>
                <td style="text-align:center; padding:4px 6px;"><input type="number" class="it-conf" value="${(it.confidence!=null?Number(it.confidence).toFixed(2):'')}" min="0" max="1" step="0.01" /></td>`;
              itemsBody.appendChild(tr);
            });
          }
        } catch {}
      }
      async function loadAverages(){
        try {
          const r = await fetch('/metrics/llm.json');
          if (!r.ok) return;
          const list = await r.json();
          const usedModelBadge = document.querySelector('.badge.ok');
          const model = usedModelBadge ? usedModelBadge.textContent.replace('LLM: ','').trim() : '';
          const entry = (list||[]).find(x => (x.model||'')===model);
          if (entry) {
            avgTpsCache = entry.avg_tps || null;
            avgWallCache = entry.avg_wall || null;
          }
        } catch {}
      }

      function computeEta(metrics){
        try {
          if (!metrics) return '';
          const p = metrics.prompt||{};
          // Estimate tokens as ~ chars/4 if we don't have token counts yet
          const estTokens = (p.chars ? Math.max(1, Math.round(p.chars/4)) : null);
          if (avgTpsCache && estTokens) {
            const sec = estTokens / avgTpsCache;
            if (isFinite(sec)) return `ETA ~ ${Math.round(sec)}s`;
          }
          if (avgWallCache) return `ETA ~ ${Math.round(avgWallCache)}s`;
        } catch {}
        return '';
      }

      function startStream(){
        const stored = storedInput ? storedInput.value : '';
        if (!stored) return;
        if (es) { try { es.close(); } catch(e){} }
        if (streamPanel) streamPanel.style.display = '';
        if (streamLog) streamLog.textContent = '';
        streamSummary.innerHTML = '';
        lastStreamObj = null; lastStreamMetrics = null;
        streamStatus.textContent = 'Connecting...';
        sid = Math.random().toString(36).slice(2);
        es = new EventSource(`/review/stream?file=${encodeURIComponent(stored)}&sid=${encodeURIComponent(sid)}`);
        const startedAt = Date.now();
        es.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            if (data.type === 'start') {
              streamStatus.textContent = `Started with model ${data.model}`;
              lastStreamMetrics = data.metrics;
              streamStats.textContent = renderMetrics(lastStreamMetrics);
              if (etaEl) {
                const e = computeEta(lastStreamMetrics);
                etaEl.textContent = e;
              }
            } else if (data.type === 'delta') {
              appendLog(data.delta);
              const elapsed = (Date.now()-startedAt)/1000;
              streamStatus.textContent = `Streaming... ${Math.round(elapsed)}s`;
            } else if (data.type === 'done') {
              appendLog('\n\n[done]\n');
              lastStreamObj = data.object || null;
              lastStreamMetrics = data.metrics || lastStreamMetrics;
              streamStats.textContent = renderMetrics(lastStreamMetrics);
              streamSummary.textContent = JSON.stringify(data.object || {}, null, 2);
              applyStreamBtn.disabled = !lastStreamObj;
              streamStatus.textContent = 'Completed';
              try { es.close(); } catch(e){}
              sid = null;
              if (etaEl) etaEl.textContent = '';
            } else if (data.type === 'error') {
              streamStatus.textContent = `Error: ${data.message}`;
              try { es.close(); } catch(e){}
              sid = null;
              if (etaEl) etaEl.textContent = '';
            }
          } catch(e) {}
        };
        es.onerror = () => {
          streamStatus.textContent = 'Connection error';
          try { es.close(); } catch(e){}
          sid = null;
          if (etaEl) etaEl.textContent = '';
        };
      }
  // Preload averages once
  loadAverages();
  if (streamBtn) streamBtn.addEventListener('click', startStream);
      if (streamLink) streamLink.addEventListener('click', (e)=>{ e.preventDefault(); startStream(); });
      if (streamStopBtn) streamStopBtn.addEventListener('click', async ()=>{
        if (es) { try { es.close(); } catch(e){} }
        if (sid) {
          try {
            const fd = new FormData(); fd.append('sid', sid);
            await fetch('/review/stream/cancel', { method: 'POST', body: fd });
          } catch(e) {}
          sid = null;
        }
        streamStatus.textContent='Stopped';
        if (etaEl) etaEl.textContent = '';
      });
      if (applyStreamBtn) applyStreamBtn.addEventListener('click', ()=>{ if (lastStreamObj) applyResultToForm(lastStreamObj); });
    })();
  </script>
</body>
</html>
