# Receipt Processing Agent â€” MVP Specification

_Last updated: Aug 14, 2025_

## ðŸŽ¯ MVP Goal
Process single-page smartphone receipt photos (JPG/PNG) via a minimal web UI, extract core fields using local OCR + local LLM, let the user review/edit, and append results to a YNAB-compatible accumulating CSV.

## In Scope (MVP)
- Manual upload via minimal web UI (FastAPI + Jinja2)
- Supported inputs: JPG/PNG, single page, upright/clear photos
- OCR with native Tesseract
- Local LLM extraction via Ollama (llama3.1:8b_q4) producing minimal JSON
- Review screen: full image preview + raw OCR text block; edit fields; save
- CSV export for YNAB import (single accumulating file)
- Local file storage for uploads and processed copies
- Open LAN access, bind 0.0.0.0:8000 (no auth for MVP)

## Out of Scope (MVP)
- Email/Gmail and Google Drive integrations
- PDFs, multi-page receipts, HEIC
- Category inference, line items, tax/tip extraction
- YNAB API push (CSV import only)
- Authentication/authorization (can add PIN/Basic later)

## End-to-End Flow
1. User opens web UI on LAN (http://0.0.0.0:8000)
2. Uploads a JPG/PNG
3. Server stores original in `data/uploads/`
4. OCR (Tesseract) â†’ raw text
5. LLM (Ollama llama3.1:8b_q4) â†’ minimal JSON { date, payee, total }
6. Review screen shows: full image, raw OCR text, extracted fields
7. User edits if needed; memo prefilled
8. On save, append row to `data/ynab_receipts.csv` and copy image to `data/processed/`

## UI Details
- Upload page: file input (accept .jpg, .jpeg, .png)
- Review page fields:
  - Date (MM/DD/YYYY)
  - Payee (text)
  - Outflow (currency/number > 0)
  - Memo (prefilled: "Generated by Agent Fineas from <filename>")
- Context panel:
  - Full image preview
  - Raw OCR text block
- Actions: Save, Save & Upload Another, Download CSV

## Data Contracts
- LLM extraction (minimal JSON)
  - Schema:
    {
      "date": string,        // best-effort as seen on receipt; UI normalizes to MM/DD/YYYY
      "payee": string,       // merchant name
      "total": number        // total amount
    }
- CSV format (YNAB-compatible accumulating file)
  - Headers: Date, Payee, Category, Memo, Outflow, Inflow
  - Row mapping:
    - Date: normalized to MM/DD/YYYY
    - Payee: from LLM/UI
    - Category: blank
    - Memo: "Generated by Agent Fineas from <filename>"
    - Outflow: total (positive number)
    - Inflow: blank

## Validation Rules (on Save)
- Date: required; normalized to MM/DD/YYYY (reject if unparseable)
- Payee: required; trimmed non-empty
- Outflow: required; numeric > 0
- Memo: required; default provided, editable
- On validation failure: show inline errors; do not append to CSV

## Storage Layout
- Uploads: `data/uploads/` (original files)
- Processed: `data/processed/` (copied, optionally timestamped)
- CSV: `data/ynab_receipts.csv` (accumulating; create with headers if absent)

## Configuration (MVP)
- Networking
  - APP_HOST: `0.0.0.0`
  - APP_PORT: `8000`
- Paths (defaults)
  - DATA_DIR: `data/`
  - UPLOADS_DIR: `data/uploads/`
  - PROCESSED_DIR: `data/processed/`
  - CSV_PATH: `data/ynab_receipts.csv`
- OCR
  - TESSERACT_LANG: `eng`
- LLM
  - OLLAMA_ENDPOINT: `http://127.0.0.1:11434` (default Ollama server)
  - MODEL: `llama3.1:8b-instruct-q4_0`

## Dependencies
- System: Tesseract OCR (native install)
- Python (suggested):
  - fastapi, uvicorn
  - jinja2
  - python-multipart (file uploads)
  - pillow (image handling)
  - pytesseract (OCR bridge)
  - requests (call Ollama HTTP API) or `ollama` Python package
  - python-dateutil (date parsing/normalization)
  - pandas or csv (standard lib) for CSV append (standard csv module is sufficient)

## Setup Notes (Linux)
- Install Tesseract (example for Debian/Ubuntu):
  ```bash
  sudo apt update
  sudo apt install -y tesseract-ocr libtesseract-dev
  tesseract --version
  ```
- Ensure Ollama is installed and model is available:
  ```bash
  ollama pull llama3.1:8b_q4
  ollama list
  ```
- Python env (example):
  ```bash
  python3 -m venv .venv
  source .venv/bin/activate
  pip install fastapi uvicorn jinja2 python-multipart pillow pytesseract requests python-dateutil
  ```

## Prompts (LLM)
- Instruction: Extract date, merchant name (payee), and total from the provided OCR text of a retail receipt.
- Constraints: Respond with ONLY valid JSON matching the schema; do not include explanations.
- Output schema: { "date": "", "payee": "", "total": 0.0 }
- Guardrails: If a field is missing, use empty string for text or 0 for numbers.

## Error Handling (MVP)
- OCR failure: show message; allow user to continue with manual entry
- LLM failure/invalid JSON: show message; allow manual entry
- CSV write failure: show error and do not mark as processed
- Always keep the original upload in `data/uploads/`; copy to `data/processed/` only on save

## Non-Goals/Constraints
- No background workers or queues
- No authentication (open LAN) â€” revisit soon if needed
- Performance target: < 30s per receipt end-to-end on typical hardware

## Acceptance Criteria
- Upload a JPG/PNG â†’ see review screen with image + raw OCR text
- Extracted fields (date, payee, total) prefilled when possible
- User can edit fields and memo; validation enforced
- On save, row is appended to `data/ynab_receipts.csv` with correct headers and formats
- Original image retained; processed copy created
- CSV imports cleanly into YNAB (manual import)

## Future Iterations (post-MVP)
- Add Google Drive monitoring and Gmail ingestion
- Add category suggestion and line-item extraction
- Add auth (PIN/Basic) when exposed on LAN
- Add YNAB API integration and account mapping
- Add cropped context snippets and confidence highlighting
- Add PDF support and HEIC conversion
- Add a queue

---

This document captures the agreed MVP scope and concrete implementation details so development can begin immediately.
